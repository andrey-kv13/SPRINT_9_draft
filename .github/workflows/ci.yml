name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Позволяет запускать вручную

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip curl
        
    - name: Pull browser image
      run: |
        docker pull selenoid/chrome:120.0 || docker pull selenoid/vnc:chrome_120.0
        
    - name: Start Selenoid
      run: |
        docker compose up -d
        sleep 20  # Даем время Selenoid запуститься
        docker ps  # Проверяем, что контейнер запущен
        # Проверяем, что Selenoid отвечает
        timeout 30 bash -c 'until curl -f http://localhost:4444/wd/hub/status; do sleep 1; done' || true
        
    - name: Clean and create allure-results directory
      run: |
        sudo rm -rf allure-results || true
        mkdir -p allure-results
        sudo chmod -R 777 allure-results
        
    - name: Run tests
      env:
        USE_REMOTE_DRIVER: "true"
        SELENOID_URI: "http://localhost:4444/wd/hub"
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest --alluredir=allure-results tests/ -v
        
    - name: Install Allure CLI
      if: always()
      run: |
        wget https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.13.9/allure-commandline-2.13.9.zip
        unzip allure-commandline-2.13.9.zip
        sudo mv allure-2.13.9 /opt/allure
        sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
        
    - name: Generate Allure Report
      if: always()
      run: |
        allure generate allure-results -o allure-report --clean || true
        
    - name: Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: allure-results/
        retention-days: 30
        if-no-files-found: ignore
        
    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report/
        retention-days: 30
        if-no-files-found: ignore
        
    - name: Stop Selenoid
      if: always()
      run: |
        docker compose down

